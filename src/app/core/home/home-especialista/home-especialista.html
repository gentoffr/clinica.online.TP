<!-- home-administrador.component.html -->
<div class="layout" [class.menu-collapsed]="menuCollapsed">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="perfil" (click)="abrirPerfil()">
      <div class="avatar-wrap">
        <span class="spinner" *ngIf="avatarCargando"></span>
        <img
          *ngIf="!avatarCargando"
          class="avatar"
          [src]="user.imagen_perfil[0]"
          alt="Avatar administrador"
        />
      </div>
      <div class="perfil-info">
        <h3 class="perfil-nombre" title="{{ user.nombre }}">{{ user.nombre }}</h3>
        <p class="perfil-email" title="{{ user.email }}">{{ user.email }}</p>
      </div>
    </div>

    <nav class="menu">
      <h4 class="menu-title">Acciones</h4>
      <ul>
        <li class="menu-item" [class.active]="activeSection==='turnos'" (click)="verTurnos()">
          <span class="bullet"></span><span class="label">Mis turnos</span>
        </li>
        <li class="menu-item" [class.active]="activeSection==='pacientes'" (click)="verPacientes()"><span class="bullet"></span><span class="label">Mis pacientes</span></li>
        <li class="menu-item"><span class="bullet"></span><span class="label">Pedidos</span></li>
        <li class="menu-item"><span class="bullet"></span><span class="label">Productos</span></li>
        <li class="menu-item"><span class="bullet"></span><span class="label">Reportes</span></li>
        <li class="menu-item">
          <span class="bullet"></span><span class="label">Configuración</span>
        </li>
        
        <footer><li class="menu-item" (click)="cerrarSesion()"><span class="bullet"></span><span class="label">Cerrar sesión</span></li></footer>
      </ul>
    </nav>
  </aside>

  <!-- Topbar (debe ser hijo directo de .layout para respetar grid-area) -->
  <header class="topbar">
    <button class="icon-btn" (click)="toggleMenu()" aria-label="Alternar menú">
      <span class="hamburger"></span>
    </button>

    <div class="topbar-center">
      <div class="placeholder pill skeleton" style="width: 220px; height: 36px"></div>
      <div class="placeholder pill skeleton hide-sm" style="width: 140px; height: 36px"></div>
    </div>

    <div class="topbar-right">
      <div class="placeholder circle skeleton" aria-hidden="true"></div>
      <div class="placeholder circle skeleton" aria-hidden="true"></div>
      <div class="mini-perfil" (click)="abrirPerfil()">
        <img class="mini-avatar" [src]="user.imagen_perfil[0]" alt="Avatar mini" />
        <span class="hide-sm ellipsis">{{ user.nombre }}</span>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="main">
    <section class="content">
      <!-- Paneles perfectamente alineados en una grilla uniforme -->
      <div class="panels">
        <section class="panel panel-animate" *ngIf="activeSection==='turnos'">
          <div class="listado">
            <app-listado-turnos (ejecutar)="onEjecutarTurno($event)" (resenar)="onCargarResena($event)" (cancelarMotivo)="onCancelarConMotivo($event)"></app-listado-turnos>
          </div>
        </section>
        <section class="panel panel-animate" *ngIf="activeSection==='pacientes'">
          <app-mis-pacientes (verPaciente)="onVerPaciente($event)"></app-mis-pacientes>
        </section>
        <section class="panel" [class.expandido]="sacandoTurno || resenando || cancelando || viendoPaciente" > 
          <ng-container *ngIf="sacandoTurno">
            <app-turno [turno]="turnoEnEjecucion" (cancelar)="sacandoTurno=false" (guardar)="onGuardarAtencion($event)"></app-turno>
          </ng-container>
          <ng-container *ngIf="resenando">
            <div class="turno-card resena-card">
              <header class="header">
                <div class="header-info">
                  <h2>Cargar reseña</h2>
                  <p class="muted">Paciente: {{ turnoParaResena?.paciente?.nombre }} {{ turnoParaResena?.paciente?.apellido }}</p>
                </div>
              </header>
              <div class="wizard">
                <label class="full" style="width: 100%">
                  <span>Reseña</span>
                  <textarea rows="6" [(ngModel)]="resenaTexto" placeholder="Escriba la reseña del turno..." class="texto-area"></textarea>
                </label>
                <footer class="actions" style="margin-top: 12px">
                  <button type="button" class="btn-secondary" (click)="cancelarResena()">Cancelar</button>
                  <button type="button" class="btn" (click)="guardarResena()" [disabled]="!resenaTexto?.trim()">Guardar</button>
                </footer>
              </div>
            </div>
          </ng-container>
          <ng-container *ngIf="cancelando">
            <div class="turno-card resena-card">
              <header class="header">
                <div class="header-info">
                  <h2>Cancelar turno</h2>
                  <p class="muted">Paciente: {{ turnoParaCancel?.paciente?.nombre }} {{ turnoParaCancel?.paciente?.apellido }}</p>
                </div>
              </header>
              <div class="wizard">
                <label class="full" style="width: 100%">
                  <span>Motivo de cancelación</span>
                  <textarea rows="6" [(ngModel)]="cancelTexto" placeholder="Explique el motivo de la cancelación..." class="texto-area"></textarea>
                </label>
                <footer class="actions" style="margin-top: 12px">
                  <button type="button" class="btn-secondary" (click)="cancelarCancelacion()">Volver</button>
                  <button type="button" class="btn" (click)="guardarCancelacion()" [disabled]="!cancelTexto?.trim()">Confirmar cancelación</button>
                </footer>
              </div>
            </div>
          </ng-container>
          <ng-container *ngIf="viendoPaciente">
            <div class="turno-card resena-card">
              <header class="header">
                <div class="header-info">
                  <h2>Detalle del paciente</h2>
                  <p class="muted">{{ pacienteSeleccionado?.paciente?.nombre }} {{ pacienteSeleccionado?.paciente?.apellido }} · {{ pacienteSeleccionado?.paciente?.email }}</p>
                </div>
              </header>
              <div class="wizard">
                <div>
                  <h3 class="titulo">Últimos 3 turnos</h3>
                  <div class="grid mini-turnos">
                    <article class="card" *ngFor="let t of ultimosTurnos; index as i">
                      <div class="numero">{{ i + 1 }}</div>
                      <div class="info">
                        <h3 class="titulo">Turno</h3>
                        <p class="detalle">Estado: {{ t.estado || '-' }}</p>
                        <p class="detalle">{{ t.fecha_turno | date : "EEEE dd/MM/yyyy, 'Hora' HH:mm" | titlecase }}</p>
                      </div>
                    </article>
                    <article class="card" *ngIf="(ultimosTurnos?.length||0)===0">
                      <div class="info">
                        <h3 class="titulo">Sin turnos</h3>
                        <p class="detalle">No hay turnos recientes</p>
                      </div>
                    </article>
                  </div>
                </div>
                <footer class="actions" style="margin-top: 12px">
                  <button type="button" class="btn-secondary" (click)="cerrarDetallePaciente()">Cerrar</button>
                </footer>
              </div>
            </div>
          </ng-container>
        </section>
      </div>
    </section>
  </main>
</div>
<app-perfil-modal *ngIf="perfilAbierto" [user]="user" (close)="cerrarPerfil()"></app-perfil-modal>

